name: Production Deploy with Approval

on:
  workflow_dispatch:
    inputs:
      description:
        description: 'Deployment description'
        required: false
        default: 'Production deployment from staging'

permissions:
  contents: write
  issues: write

env:
  APPROVERS: 'rifqi-thufail,abyansyah052,akhtar2344'
  APPROVAL_TIMEOUT_MINUTES: 60

jobs:
  # Job 1: Buat issue untuk approval dan tunggu
  request-and-wait-approval:
    runs-on: ubuntu-latest
    outputs:
      approved: ${{ steps.wait-approval.outputs.approved }}
      approver: ${{ steps.wait-approval.outputs.approver }}
      issue_number: ${{ steps.create-issue.outputs.issue_number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create approval request issue
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const approvers = process.env.APPROVERS.split(',');
            const mentions = approvers.map(a => `@${a}`).join(', ');
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: ` Production Deployment Approval Request - Run #${context.runNumber}`,
              body: `## Production Deployment Request
            
            **Requested by:** @${context.actor}
            **Description:** ${{ github.event.inputs.description }}
            **Workflow Run:** [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Time:** ${new Date().toISOString()}
            
            ---
            
            ###  Approvers Required
            ${mentions}
            
            ###  To Approve
            Comment one of: \`approved\`, \`approve\`, \`lgtm\`, \`yes\`
            
            ###  To Deny
            Comment one of: \`deny\`, \`denied\`, \`no\`, \`reject\`
            
            ---
            
             **Timeout:** ${process.env.APPROVAL_TIMEOUT_MINUTES} minutes
            
            The workflow will automatically deploy to production once approved.`,
              labels: ['deployment', 'production', 'awaiting-approval']
            });
            
            console.log(`Created issue #${issue.data.number}`);
            core.setOutput('issue_number', issue.data.number);
            return issue.data.number;

      - name: Wait for approval
        id: wait-approval
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.create-issue.outputs.issue_number }};
            const approvers = process.env.APPROVERS.split(',').map(a => a.trim().toLowerCase());
            const timeoutMs = parseInt(process.env.APPROVAL_TIMEOUT_MINUTES) * 60 * 1000;
            const pollInterval = 15000; // 15 detik
            const startTime = Date.now();
            
            const approveKeywords = ['approved', 'approve', 'lgtm', 'yes'];
            const denyKeywords = ['deny', 'denied', 'no', 'reject'];
            
            console.log(` Waiting for approval on issue #${issueNumber}`);
            console.log(` Authorized approvers: ${approvers.join(', ')}`);
            console.log(` Timeout: ${process.env.APPROVAL_TIMEOUT_MINUTES} minutes`);
            
            let lastCheckedCommentId = 0;
            
            while (true) {
              // Check timeout
              if (Date.now() - startTime > timeoutMs) {
                console.log(' Approval timeout reached');
                
                // Comment timeout pada issue
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: ` **Approval Timeout**\n\nThis deployment request has timed out after ${process.env.APPROVAL_TIMEOUT_MINUTES} minutes without approval.\n\nWorkflow cancelled.`
                });
                
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  state: 'closed',
                  labels: ['deployment', 'production', 'timeout']
                });
                
                core.setOutput('approved', 'false');
                core.setFailed('Deployment approval timeout');
                return;
              }
              
              // Fetch comments
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                per_page: 100
              });
              
              // Process comments yang belum dicheck
              for (const comment of comments.data) {
                if (comment.id <= lastCheckedCommentId) continue;
                
                const author = comment.user.login.toLowerCase();
                const body = comment.body.toLowerCase().trim();
                
                console.log(` Comment from @${author}: "${comment.body.substring(0, 50)}..."`);
                
                // Check apakah author adalah approver
                if (!approvers.includes(author)) {
                  console.log(` @${author} is not an authorized approver, skipping`);
                  continue;
                }
                
                // Check untuk denial
                if (denyKeywords.some(kw => body.includes(kw))) {
                  console.log(` Deployment DENIED by @${author}`);
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: ` **Deployment Denied**\n\nDenied by @${author}\n\nWorkflow cancelled.`
                  });
                  
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    state: 'closed',
                    labels: ['deployment', 'production', 'denied']
                  });
                  
                  core.setOutput('approved', 'false');
                  core.setFailed(`Deployment denied by ${author}`);
                  return;
                }
                
                // Check untuk approval
                if (approveKeywords.some(kw => body.includes(kw))) {
                  console.log(` Deployment APPROVED by @${author}`);
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: ` **Deployment Approved**\n\nApproved by @${author}\n\nProceeding with production deployment...`
                  });
                  
                  core.setOutput('approved', 'true');
                  core.setOutput('approver', author);
                  return;
                }
                
                lastCheckedCommentId = comment.id;
              }
              
              // Update lastCheckedCommentId
              if (comments.data.length > 0) {
                lastCheckedCommentId = Math.max(lastCheckedCommentId, ...comments.data.map(c => c.id));
              }
              
              const elapsed = Math.floor((Date.now() - startTime) / 1000);
              console.log(` Waiting... (${elapsed}s elapsed, checking every 15s)`);
              
              // Wait before next poll
              await new Promise(resolve => setTimeout(resolve, pollInterval));
            }

  # Job 2: Deploy ke production HANYA jika approved (SAMA dengan staging)
  deploy-to-production:
    needs: request-and-wait-approval
    if: needs.request-and-wait-approval.outputs.approved == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout staging branch
        uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge staging to main
        run: |
          git fetch origin main
          git checkout main
          git merge origin/staging -m "Merge staging to main for production deploy (approved by ${{ needs.request-and-wait-approval.outputs.approver }})"
          git push origin main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # Build frontend di GitHub Actions (SAMA seperti staging)
      - name: Build frontend
        working-directory: ./frontend
        env:
          REACT_APP_API_URL: http://${{ secrets.EC2_HOST }}:5001
        run: |
          npm ci
          npm run build

      # Create deployment ZIP (SAMA seperti staging)
      - name: Create deployment package
        run: |
          mkdir -p deploy-package/backend
          cp -r frontend/build deploy-package/frontend-build
          # Copy backend tanpa node_modules
          cp backend/package*.json deploy-package/backend/
          cp backend/server.js deploy-package/backend/
          cp -r backend/config deploy-package/backend/ 2>/dev/null || true
          cp -r backend/middleware deploy-package/backend/ 2>/dev/null || true
          cp -r backend/models deploy-package/backend/ 2>/dev/null || true
          cp -r backend/routes deploy-package/backend/ 2>/dev/null || true
          cp backend/schema.sql deploy-package/backend/ 2>/dev/null || true
          cd deploy-package && zip -r ../production-deploy.zip .
          ls -lh ../production-deploy.zip

      # Upload ZIP ke EC2 (SAMA seperti staging)
      - name: Upload deployment package to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "production-deploy.zip"
          target: "/tmp"

      # Deploy di EC2 (SAMA seperti staging)
      - name: Deploy to Production EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          command_timeout: 5m
          script: |
            set -e
            
            PROJECT_DIR="$HOME/pso-pipeline-production"
            
            # Create project directory if not exists
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"
            
            # Unzip deployment package (overwrite existing)
            unzip -o /tmp/production-deploy.zip -d .
            
            # Deploy frontend to nginx
            sudo rm -rf /var/www/html/*
            sudo cp -r frontend-build/* /var/www/html/
            sudo chown -R nginx:nginx /var/www/html/ 2>/dev/null || sudo chown -R www-data:www-data /var/www/html/ 2>/dev/null || true
            sudo chmod -R 755 /var/www/html/
            
            # Install backend dependencies
            cd backend
            npm ci --omit=dev
            
            # Create uploads directory
            mkdir -p uploads/materials
            chmod 755 uploads uploads/materials
            
            # Restart backend with PM2
            pm2 delete material-api-prod 2>/dev/null || true
            pm2 start server.js --name material-api-prod -i 1
            pm2 save
            
            # Restart nginx
            sudo systemctl restart nginx
            
            # Cleanup
            rm -f /tmp/production-deploy.zip
            
            echo "Production deployment completed successfully"

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            pm2 list | grep -E "material-api-prod" || true
            sudo systemctl is-active nginx || true
            echo "Production services check completed"

      - name: Health check
        run: |
          echo "Running health checks..."
          sleep 10
          
          BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://${{ secrets.EC2_HOST }}:5001" || echo "000")
          echo "Backend HTTP status: $BACKEND_STATUS"
          
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://${{ secrets.EC2_HOST }}" || echo "000")
          echo "Frontend HTTP status: $FRONTEND_STATUS"

      - name: Update approval issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.request-and-wait-approval.outputs.issue_number }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## Production Deployment Successful!
            
            **Deployed at:** ${new Date().toISOString()}
            **Approved by:** @${{ needs.request-and-wait-approval.outputs.approver }}
            
            ### Production URLs
            - **Frontend:** http://${{ secrets.EC2_HOST }}
            - **Backend API:** http://${{ secrets.EC2_HOST }}:5001
            
            Deployment verified and running.`
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              labels: ['deployment', 'production', 'deployed']
            });

  # Job 3: Handle jika tidak di-approve (timeout/denied)
  handle-not-approved:
    needs: request-and-wait-approval
    if: failure() || needs.request-and-wait-approval.outputs.approved != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Log deployment cancelled
        run: |
          echo " Deployment was not approved or was denied/timed out"
          echo "Approval status: ${{ needs.request-and-wait-approval.outputs.approved }}"
